<!DOCTYPE html>
<html>

<head>
  <title>My LIFF app</title>
</head>

<body>
  <h1>Your name is <span id="user_name"></span>, right?</h1>
  <p>status now is: <span id="user_status"></span></p>
  <div>
    <ul id="logger">
      <li>Window opened</li>
    </ul>
  </div>
  <p>response is: <span id="http_response"></span></p>
  <button onclick="location.reload();">Reload the page</button>
  <button onclick="access_data(user_id, access_token);">Access data</button>
  <script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
  <script>
    let access_token;
    let user_id;

    let add_log = (log) =>{
      let logger_ul = document.getElementById("logger");
      let new_log = document.createElement("li");
      new_log.innerText = log;
      logger_ul.appendChild(new_log);

      let user_status_span = document.getElementById("user_status");
      user_status_span.innerText = log;
    };

    let access_data = (user_id, access_token) =>{
      add_log("access_data started");
      data_url = "https://2t82fs2tia.execute-api.ap-northeast-1.amazonaws.com/dev/data/?access_token=" + access_token + "&user_id=" + user_id;
      let data_json = {};
      fetch(data_url)
      .then(res =>{
        if(res.ok){
          add_log("access url correctly");
          return res.json();
        }
      })
      .then(data =>{
        let response_span = document.getElementById("http_response");
        response_span.innerText = data.message + " and you are validated: " + data.validated;
      })
      .catch(err =>{
        add_log("access url fail: " + err.toString());
        console.log(err);
      });
    };

    let init = () =>{
      add_log("init started");

      liff.init(
      data => {
          user_id = data.context.userId;
          access_token = liff.getAccessToken();

          liff.getProfile()
          .then(profile => {
            const user_name = profile.displayName;
            let user_name_span = document.getElementById("user_name");
            user_name_span.innerText = user_name;

            add_log("getProfile done");
          })
          .catch(err =>{
            console.log('err', err);
            add_log("err during getProfile: " + err.toString());
          });
        },
      err => {
          // LIFF initialization failed
          add_log("err LIFF initialization failed: " + err.toString());
      });

      add_log("LIFF init done");

      access_data(user_id, access_token);
    };

    window.onload = init();
  </script>
</body>

</html>